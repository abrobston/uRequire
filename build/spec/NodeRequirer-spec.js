// Generated by CoffeeScript 1.6.3
var Dependency, NR, chai, deepEqual, dirname, equal, expect, fs, like, likeBA, moduleNameBR, notEqual, nr, ok, rjsconf, upath, webRootMap, _, _ref,
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

chai = require('chai');

expect = chai.expect;

_ref = require('./spec-helpers'), deepEqual = _ref.deepEqual, like = _ref.like, likeBA = _ref.likeBA, ok = _ref.ok, equal = _ref.equal, notEqual = _ref.notEqual;

_ = require('lodash');

fs = require('fs');

upath = require('../code/paths/upath');

NR = require("../code/NodeRequirer");

Dependency = require("../code/fileResources/Dependency");

moduleNameBR = 'path/fromBundleRoot/toModuleName.js';

dirname = upath.dirname("" + __dirname + "/" + moduleNameBR);

webRootMap = '../fakeWebRoot/mapping/';

rjsconf = JSON.parse(fs.readFileSync("" + __dirname + "/requirejs.config.json", 'utf-8'));

nr = new NR(moduleNameBR, module, dirname, webRootMap);

describe("NodeRequirer basics:", function() {
  it("identifies path", function() {
    return equal(nr.path, upath.normalize("" + __dirname + "/"));
  });
  it("identifies webRootMap", function() {
    return equal(nr.webRoot, upath.normalize("" + __dirname + "/" + webRootMap));
  });
  it("loads 'requirejs.config.json' from path", function() {
    return deepEqual(nr.getRequireJSConfig(), rjsconf);
  });
  it("nodejs require-mock called with correct module path", function() {
    var path;
    path = '';
    nr.nodeRequire = function(m) {
      return path = m;
    };
    nr.require('path/fromBundleRoot/to/anotherModule');
    return equal(path, upath.normalize("" + __dirname + "/path/fromBundleRoot/to/anotherModule"));
  });
  return describe("resolves Dependency paths:", function() {
    it("global-looking Dependency", function() {
      var resDep, resolvedDeps, _i, _len, _ref1, _results;
      resolvedDeps = nr.resolvePaths(new Dependency('underscore', {
        path: moduleNameBR
      }));
      _ref1 = ['underscore', upath.normalize("" + __dirname + "/underscore")];
      _results = [];
      for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
        resDep = _ref1[_i];
        _results.push(ok(__indexOf.call(resolvedDeps, resDep) >= 0));
      }
      return _results;
    });
    it("bundleRelative Dependency", function() {
      var depStr;
      depStr = 'some/pathTo/depName';
      return deepEqual(nr.resolvePaths(new Dependency(depStr, {
        path: moduleNameBR
      })), [upath.normalize("" + __dirname + "/" + depStr)]);
    });
    it("fileRelative Dependency", function() {
      return deepEqual(nr.resolvePaths(new Dependency('./rel/pathTo/depName', {
        path: moduleNameBR
      })), [upath.normalize("" + __dirname + "/" + (upath.dirname(moduleNameBR)) + "/rel/pathTo/depName")]);
    });
    return it("requirejs config {paths:..} Dependency", function() {
      return deepEqual(nr.resolvePaths(new Dependency('src/depName', {
        path: moduleNameBR
      })), [upath.normalize("" + __dirname + "/../../src/depName")]);
    });
  });
});

describe("NodeRequirer uses requirejs config :", function() {
  it("statically stores parsed 'requirejs.config.json' for this path", function() {
    return deepEqual(NR.prototype.requireJSConfigs[nr.path], rjsconf);
  });
  it("identifies path, via baseUrl (relative to webRootMap)", function() {
    var baseUrl_webMap_relative;
    baseUrl_webMap_relative = "/some/webRootMap/path";
    NR.prototype.requireJSConfigs[upath.normalize(__dirname + '/')].baseUrl = baseUrl_webMap_relative;
    nr = new NR(moduleNameBR, module, dirname, webRootMap);
    return equal(nr.path, upath.normalize("" + __dirname + "/" + webRootMap + "/" + baseUrl_webMap_relative + "/"));
  });
  return it("identifies path, via baseUrl (relative to path)", function() {
    var baseUrl_webMap_bundleRootRelative;
    baseUrl_webMap_bundleRootRelative = "../some/other/path";
    NR.prototype.requireJSConfigs[upath.normalize(__dirname + '/')].baseUrl = baseUrl_webMap_bundleRootRelative;
    nr = new NR(moduleNameBR, module, dirname, webRootMap);
    return equal(nr.path, upath.normalize("" + __dirname + "/" + baseUrl_webMap_bundleRootRelative + "/"));
  });
});
