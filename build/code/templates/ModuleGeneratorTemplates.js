// Generated by CoffeeScript 1.6.3
var ModuleGeneratorTemplates, Template, VERSION, isFileInSpecs, isTruthyOrIsFileInSpecs, l, pathRelative, _, _B,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

_ = require('lodash');

_B = require('uberscore');

l = new _B.Logger('urequire/ModuleGeneratorTemplates');

isFileInSpecs = require('../utils/isFileInSpecs');

pathRelative = require('../paths/pathRelative');

Template = require('./Template');

VERSION = require('../urequire').VERSION;

isTruthyOrIsFileInSpecs = function(configValue, filename) {
  return configValue && (!_.isArray(configValue) || (_.isArray(configValue) && isFileInSpecs(filename, configValue)));
};

ModuleGeneratorTemplates = (function(_super) {
  __extends(ModuleGeneratorTemplates, _super);

  function ModuleGeneratorTemplates(module) {
    this.module = module;
  }

  Object.defineProperties(ModuleGeneratorTemplates.prototype, {
    headerBanner: {
      get: function() {
        return "// Generated by uRequire v" + VERSION;
      }
    },
    moduleNamePrint: {
      get: function() {
        if (this.module.name) {
          return "'" + this.module.name + "', ";
        } else {
          return "";
        }
      }
    },
    /* Object.defineProperties @::,  parameters of the factory method, eg 'require, _, personModel'*/

    parametersPrint: {
      get: function() {
        var par;
        return "require" + (this.module.kind === 'nodejs' ? ', exports, module' : '') + (((function() {
          var _i, _len, _ref, _results;
          _ref = this.module.parameters;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            par = _ref[_i];
            _results.push(", " + par);
          }
          return _results;
        }).call(this)).join(''));
      }
    },
    defineArrayDepsPrint: {
      get: function() {
        var dep;
        return "" + (_.isEmpty(this.module.defineArrayDeps) ? "" : this.module.kind === 'nodejs' ? "['require', 'exports', 'module'" : "['require'") + (((function() {
          var _i, _len, _ref, _results;
          _ref = this.module.defineArrayDeps;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            dep = _ref[_i];
            _results.push(", " + (dep.name({
              quote: true
            })));
          }
          return _results;
        }).call(this)).join('')) + (_.isEmpty(this.module.defineArrayDeps) ? '' : '], ');
      }
    },
    bodyStartBanner: {
      get: function() {
        return "// uRequire v" + VERSION + ": START body of original " + this.module.kind + " module";
      }
    },
    bodyEndBanner: {
      get: function() {
        return "// uRequire v" + VERSION + ": END body of original " + this.module.kind + " module";
      }
    },
    beforeBody: {
      get: function() {
        if (this.module.beforeBody) {
          return "// uRequire v" + VERSION + ": module.beforeBody contents \n " + this.module.beforeBody;
        } else {
          return '';
        }
      }
    },
    afterBody: {
      get: function() {
        if (this.module.afterBody) {
          return "// uRequire v" + VERSION + ": module.afterBody contents \n " + this.module.afterBody;
        } else {
          return '';
        }
      }
    },
    factoryBodyAMD: {
      get: function() {
        return "" + this.beforeBody + "\n" + this.bodyStartBanner + "\n" + this.module.factoryBody + "\n" + this.bodyEndBanner + "\n" + this.afterBody + "\n" + (this.module.kind === 'nodejs' ? '\nreturn module.exports;' : '');
      }
    },
    factoryBodyNodejs: {
      get: function() {
        return "" + this.beforeBody + "\n" + this.bodyStartBanner + "\n" + (this.module.kind === 'AMD' ? "module.exports = " + (this._functionIIFE(this.module.factoryBody)) + ";" : this.module.factoryBody) + "\n" + this.bodyEndBanner + "\n" + this.afterBody;
      }
    },
    preDefineIIFEBodyPrint: {
      get: function() {
        if (this.module.preDefineIIFEBody) {
          return "// uRequire v" + VERSION + ": START of preDefineIIFEBody - statements/declarations before define(), enclosed in an IIFE (function(){})().\n" + this.module.preDefineIIFEBody + "\n// uRequire v" + VERSION + ": END of preDefineIIFEBody\n";
        } else {
          return '';
        }
      }
    },
    runtimeInfoPrint: {
      get: function() {
        if (isTruthyOrIsFileInSpecs(this.module.bundle.build.runtimeInfo, this.module.dstFilename)) {
          return this.runtimeInfo + '\n';
        } else {
          return '';
        }
      }
    },
    useStrictPrint: {
      get: function() {
        if (isTruthyOrIsFileInSpecs(this.module.bundle.build.useStrict, this.module.dstFilename)) {
          return "'use strict';\n";
        } else {
          return '';
        }
      }
    },
    isRootExports: {
      get: function() {
        var _ref;
        return !(_.isEmpty(this.module.flags.rootExports) || ((_ref = this.module.bundle) != null ? _ref.noRootExports : void 0));
      }
    }
  });

  /* private*/


  ModuleGeneratorTemplates.prototype._rootExportsNoConflict = function(rootName) {
    var exp, exportedVar, i;
    if (rootName == null) {
      rootName = 'root';
    }
    return ("" + (this.module.flags.noConflict ? ((function() {
      var _i, _len, _ref, _results;
      _ref = this.module.flags.rootExports;
      _results = [];
      for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
        exp = _ref[i];
        _results.push("" + (i === 0 ? 'var ' : '    ') + "__old__" + exp + " = " + rootName + "." + exp);
      }
      return _results;
    }).call(this)).join(',\n') + ';' : '') + "\n" + (((function() {
      var _i, _len, _ref, _results;
      _ref = this.module.flags.rootExports;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        exportedVar = _ref[_i];
        _results.push("" + rootName + "." + exportedVar + " = __umodule__");
      }
      return _results;
    }).call(this)).join(';\n')) + ";") + (this.module.flags.noConflict ? "__umodule__.noConflict = " + this._function("" + (((function() {
      var _i, _len, _ref, _results;
      _ref = this.module.flags.rootExports;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        exp = _ref[_i];
        _results.push("  " + rootName + "." + exp + " = __old__" + exp);
      }
      return _results;
    }).call(this)).join(';\n')) + ";\nreturn __umodule__;") + ';' : '') + "\nreturn __umodule__;";
  };

  /*
    UMD template - runs AS-IS on both Web/AMD and nodejs (having 'npm install urequire').
    * Uses `NodeRequirer` to perform `require`s.
  */


  ModuleGeneratorTemplates.prototype.UMD = function() {
    return this.headerBanner + " - template: 'UMD'\n" + this._UMD();
  };

  ModuleGeneratorTemplates.prototype.UMDplain = function() {
    return this.headerBanner + " - template: 'UMDplain'\n" + this._UMD(false);
  };

  ModuleGeneratorTemplates.prototype._UMD = function(isNodeRequirer) {
    var fullBody, nDep, nr;
    if (isNodeRequirer == null) {
      isNodeRequirer = true;
    }
    nr = isNodeRequirer ? "nr." : "";
    fullBody = this.useStrictPrint + this.runtimeInfoPrint + this.preDefineIIFEBodyPrint + '\n' + this._functionIIFE("" + (this.isRootExports ? "var rootExport = " + (this._function(this._rootExportsNoConflict(), 'root, __umodule__')) + ";" : '') + "\n\nif (typeof exports === 'object') {\n   " + (isNodeRequirer ? "var nr = new (require('urequire').NodeRequirer) ('" + this.module.path + "', module, __dirname, '" + this.module.webRootMap + "');" : "") + "\n   module.exports = " + (this.isRootExports ? 'rootExport(global, ' : '') + "factory(" + nr + "require" + (this.module.kind === 'nodejs' ? ', exports, module' : '') + (((function() {
      var _i, _len, _ref, _results;
      _ref = this.module.nodeDeps;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        nDep = _ref[_i];
        if (nDep.isSystem) {
          _results.push(', ' + nDep.name());
        } else {
          _results.push(", " + nr + "require(" + (nDep.name({
            quote: true
          })) + ")");
        }
      }
      return _results;
    }).call(this)).join('')) + ")" + (this.isRootExports ? ')' : '') + ";\n } else if (typeof define === 'function' && define.amd) {\n     define(" + this.moduleNamePrint + this.defineArrayDepsPrint + (!this.isRootExports ? 'factory' : this._function("return rootExport(window, factory(" + this.parametersPrint + "));", this.parametersPrint)) + ");\n }", 'factory', this._function(this.factoryBodyAMD, this.parametersPrint));
    return this._fullBodyBareIIFEGW(fullBody);
  };

  ModuleGeneratorTemplates.prototype._fullBodyBareIIFEGW = function(fullBody) {
    var root;
    return (isTruthyOrIsFileInSpecs(this.module.bundle.build.bare, this.module.dstFilename) ? fullBody : isTruthyOrIsFileInSpecs(this.module.bundle.build.globalWindow, this.module.dstFilename) ? (root = "(typeof exports === 'object' ? global : window)", this._functionIIFE(fullBody, 'window', root, 'global', root)) : this._functionIIFE(fullBody)) + ';';
  };

  /* AMD template
      Simple `define(['dep'], function(dep){...body...}})`
      Runs only on WEB/AMD/RequireJs (and hopefully soon in node through uRequire'd *driven* RequireJS).
  */


  ModuleGeneratorTemplates.prototype.AMD = function() {
    var fullBody;
    fullBody = this.useStrictPrint + this.runtimeInfoPrint + this.preDefineIIFEBodyPrint + this._AMD_plain_define();
    return this.headerBanner + " - template: 'AMD'\n" + this._fullBodyBareIIFEGW(fullBody);
  };

  ModuleGeneratorTemplates.prototype._AMD_plain_define = function() {
    return "define(" + this.moduleNamePrint + this.defineArrayDepsPrint + "\n  " + (this._function(!this.isRootExports ? this.factoryBodyAMD : "var __umodule__ = " + this._functionIIFE(this.factoryBodyAMD, this.parametersPrint, this.parametersPrint) + ";\n" + this._rootExportsNoConflict('window'), this.parametersPrint)) + "\n);";
  };

  ModuleGeneratorTemplates.prototype.combined = function() {
    return this._AMD_plain_define();
  };

  ModuleGeneratorTemplates.prototype.nodejs = function() {
    var dep, fullBody, param, paramPrintCount, pi;
    paramPrintCount = 0;
    fullBody = "" + this.useStrictPrint + "\n" + this.preDefineIIFEBodyPrint + "\n" + this.runtimeInfoPrint + "\n" + (_.any(this.module.nodeDeps, function(dep) {
      return !dep.isSystem;
    }) ? "\nvar " : '') + (((function() {
      var _i, _len, _ref, _results;
      _ref = this.module.parameters;
      _results = [];
      for (pi = _i = 0, _len = _ref.length; _i < _len; pi = ++_i) {
        param = _ref[pi];
        if (!(dep = this.module.nodeDeps[pi]).isSystem) {
          _results.push("" + (paramPrintCount++ === 0 ? '' : '    ') + param + " = require(" + (dep.name({
            quote: true
          })) + ")");
        }
      }
      return _results;
    }).call(this)).join(',\n')) + ";\n" + this.factoryBodyNodejs + "\n" + (this.isRootExports ? "var __umodule__ = module.exports;\n " + (this._rootExportsNoConflict('global')) : '');
    return this.headerBanner + " - template: 'nodejs'\n" + this._fullBodyBareIIFEGW(fullBody);
  };

  return ModuleGeneratorTemplates;

})(Template);

module.exports = ModuleGeneratorTemplates;
